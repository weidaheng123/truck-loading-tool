<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2962FF">
    <meta name="description" content="ç²¾å‡†è£…è½¦ç»ˆç«¯ - ç§»åŠ¨ç«¯è£…è½¦ç®¡ç†å·¥å…·">
    <title>ç²¾å‡†è£…è½¦ç»ˆç«¯ (äº‘ç«¯ç‰ˆ)</title>
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%232962FF'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='40' fill='white' text-anchor='middle'%3EğŸš›%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --primary: #2962FF; --accent: #FFC107; --text: #eee; --border: #333; --success: #00C853; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; padding-bottom: 120px; touch-action: manipulation; user-select: none; -webkit-user-select: none; }
        
        /* === é¡¶éƒ¨ï¼šæœ¬è½¦ä¿¡æ¯æ  (å›ºå®š) === */
        .top-bar { background: #263238; padding: 12px; border-bottom: 2px solid var(--primary); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.4); }
        .trip-info { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
        .input-box { flex: 1; background: #37474F; border: 1px solid #455A64; color: #fff; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: bold; outline: none; transition: border 0.2s; }
        .input-box:focus { border-color: var(--primary); background: #2f3e46; }
        .input-box.small { flex: none; width: 120px; }
        
        /* è½¦è¾†åˆ‡æ¢æ  */
        .truck-switcher { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .truck-switcher::-webkit-scrollbar { display: none; }
        .truck-tab { background: #37474F; border: 1px solid #455A64; color: #fff; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .truck-tab.active { background: var(--primary); border-color: var(--primary); font-weight: bold; }
        .truck-tab.new { background: #1b5e20; border-color: var(--success); }
        
        /* å®¢æˆ·åˆ‡æ¢æ  */
        .customer-switcher { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; scrollbar-width: none; }
        .customer-switcher::-webkit-scrollbar { display: none; }
        .customer-tab { background: #37474F; border: 1px solid #455A64; color: #fff; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; white-space: nowrap; cursor: pointer; transition: all 0.2s; }
        .customer-tab.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: bold; }
        .customer-tab.new { background: #1b5e20; border-color: var(--success); }
        
        /* å®æ—¶ç»Ÿè®¡æ¡ */
        .stats-scroller { display: flex; overflow-x: auto; gap: 8px; padding-bottom: 4px; scrollbar-width: none; }
        .stats-scroller::-webkit-scrollbar { display: none; }
        .stat-pill { background: #37474F; padding: 8px 14px; border-radius: 20px; font-size: 0.9rem; white-space: nowrap; display: flex; align-items: center; gap: 5px; border: 1px solid #455A64; }
        .stat-pill.total { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; }
        .stat-num { color: var(--accent); font-weight: bold; font-size: 1.2rem; }

        /* === æ ¸å¿ƒé€‰æ‹©åŒº === */
        .section { background: var(--panel); margin: 12px; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .section-title { color: #90A4AE; font-size: 0.9rem; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; display: flex; justify-content: space-between; }
        
        /* ç½‘æ ¼æŒ‰é’® - ç¼©å°å›¾æ ‡åˆ°1/4 */
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; }
        .select-btn { background: #2c2c2c; border: 1px solid #444; color: #bbb; padding: 5px 3px; border-radius: 4px; text-align: center; font-size: 0.6rem; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center; min-height: 20px; word-break: break-all; line-height: 1.1; }
        .select-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; transform: scale(1.02); box-shadow: 0 4px 10px rgba(41, 98, 255, 0.3); }

        /* æ•°é‡æ§åˆ¶ */
        .qty-wrapper { display: flex; align-items: center; gap: 10px; }
        .qty-screen { flex: 1; background: #000; color: var(--success); font-family: monospace; font-size: 2.8rem; text-align: center; border-radius: 10px; padding: 8px; border: 1px solid #333; font-weight: bold; letter-spacing: -1px; }
        .numpad { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 150px; }
        .num-btn { background: #333; border: 1px solid #444; color: #fff; padding: 14px; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; }
        .num-btn:active { background: #555; }

        /* === åº•éƒ¨æ“ä½œæ  === */
        .bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1a1a1a; padding: 15px; border-top: 1px solid #333; display: flex; gap: 15px; z-index: 200; box-shadow: 0 -4px 10px rgba(0,0,0,0.3); }
        .main-btn { flex: 1; background: var(--success); color: #fff; border: none; padding: 20px; border-radius: 10px; font-size: 1.5rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; line-height: 1; box-shadow: 0 4px 6px rgba(0, 200, 83, 0.3); cursor: pointer; }
        .main-btn:active { transform: translateY(2px); background: #00a040; }
        .main-btn span { font-size: 0.9rem; margin-top: 8px; opacity: 0.9; font-weight: normal; }
        .settings-icon { padding: 0 15px; background: none; border: none; font-size: 1.8rem; cursor: pointer; opacity: 0.5; }

        /* === å†å²è®°å½• === */
        .history-list { list-style: none; padding: 0; margin: 12px; padding-bottom: 20px; }
        .history-item { background: #263238; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #546E7A; animation: slideIn 0.3s; position: relative; }
        .history-item.recent { border-left-color: var(--success); background: #1b5e20; }
        .history-item::before { content: ''; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background: #546E7A; color: #fff; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; }
        .history-item.recent::before { background: var(--success); }
        @keyframes slideIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        /* === å¼¹çª— === */
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 300; overflow-y: auto; padding: 20px; backdrop-filter: blur(5px); }
        .overlay.show { display: block; }
        .panel { background: #212121; padding: 20px; border-radius: 12px; border: 1px solid #333; }
        .panel h2 { margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        textarea { width: 100%; height: 140px; background: #121212; color: #ccc; border: 1px solid #333; padding: 12px; border-radius: 8px; font-family: monospace; resize: vertical; font-size: 1rem; }
        .btn { padding: 14px 22px; border-radius: 8px; border: none; color: #fff; cursor: pointer; font-size: 1rem; margin-right: 10px; margin-top: 10px; }
        .btn-blue { background: var(--primary); }
        .btn-red { background: #d32f2f; }
        .btn-grey { background: #616161; }
        
        /* === å“åº”å¼è°ƒæ•´ === */
        @media (max-width: 480px) {
            .grid-container { grid-template-columns: repeat(2, 1fr); }
            .qty-screen { font-size: 2.2rem; }
            .main-btn { font-size: 1.3rem; }
            .numpad { width: 130px; }
        }
        
        /* === åŠ è½½åŠ¨ç”» === */
        .loading { opacity: 0.6; pointer-events: none; }
        .loading::after { content: ''; display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨ï¼šè½¦æ¬¡ä¿¡æ¯ä¸ç»Ÿè®¡ -->
<div class="top-bar">
    <div class="trip-info">
        <input type="text" id="plate" class="input-box" placeholder="è½¦ç‰Œå· (å¦‚: èµ£C...)" onchange="saveState()" autocomplete="off">
    </div>
    <div class="truck-switcher" id="truck-switcher">
        <div class="truck-tab active" data-index="0">å½“å‰è½¦è¾†</div>
        <div class="truck-tab new" onclick="addNewTruck()">+ æ·»åŠ è½¦è¾†</div>
    </div>
    <div class="stats-scroller" id="stats-bar">
        <div class="stat-pill total">æ€»è®¡ <span class="stat-num" id="total-val">0</span></div>
        <!-- åŠ¨æ€ç”Ÿæˆ -->
    </div>
</div>

<!-- ä¸­éƒ¨ï¼šé€‰æ‹©åŒº -->
<div class="section">
    <div class="section-title">Step 0: é€‰æ‹©å®¢æˆ·</div>
    <input type="text" id="cust" class="input-box" placeholder="å®¢æˆ·åç§° (å¦‚: åæ¶¦)" autocomplete="off" oninput="updateCustomerName()">
</div>

<div class="section">
    <div class="section-title">Step 1: é€‰æ‹©å†œæˆ· / è´§æº</div>
    <div class="grid-container" id="grid-source"></div>
</div>

<div class="section">
    <div class="section-title">Step 2: é€‰æ‹©è§„æ ¼ / å“ç§</div>
    <div class="grid-container" id="grid-spec"></div>
</div>

<div class="section">
    <div class="section-title">Step 3: ç¡®è®¤æ•°é‡</div>
    <div class="qty-wrapper">
        <div class="qty-screen" id="qty-val">70</div>
        <div class="numpad">
            <button class="num-btn" onclick="addQty(-10)">-10</button>
            <button class="num-btn" onclick="addQty(10)">+10</button>
            <button class="num-btn" onclick="addQty(-1)">-1</button>
            <button class="num-btn" onclick="addQty(1)">+1</button>
        </div>
    </div>
</div>

<!-- å†å²åˆ—è¡¨ -->
<ul class="history-list" id="history"></ul>

<!-- åº•éƒ¨ï¼šå¤§æŒ‰é’® -->
<div class="bottom-bar">
    <button class="settings-icon" onclick="openConfig()">âš™ï¸</button>
    <button class="main-btn" onclick="commit()">
        ç¡®è®¤è®°å½•
        <span id="btn-subtext">...</span>
    </button>
</div>

<!-- é…ç½®å¼¹çª— -->
<div class="overlay" id="config-overlay">
    <div class="panel">
        <h2>ğŸ› ï¸ ç³»ç»Ÿé…ç½®</h2>
        <p style="color:#888; font-size:0.9rem;">è¯·ä¿®æ”¹ä¸‹æ–¹åˆ—è¡¨ï¼Œç”¨é€—å·åˆ†éš”ã€‚</p>
        
        <label style="color:var(--primary)">å†œæˆ·åˆ—è¡¨:</label>
        <textarea id="cfg-source"></textarea>
        
        <label style="color:var(--primary)">è§„æ ¼åˆ—è¡¨:</label>
        <textarea id="cfg-spec"></textarea>

        <div style="margin-top:20px; display:flex; flex-wrap:wrap; gap:10px;">
            <button class="btn btn-blue" onclick="saveConfig()">ä¿å­˜å¹¶é‡å¯</button>
            <button class="btn btn-grey" onclick="closeConfig()">å–æ¶ˆ</button>
        </div>

        <hr style="border-color:#333; margin:20px 0;">
        <button class="btn btn-grey" onclick="exportData()">ğŸ“¥ å¯¼å‡ºExcel/CSV</button>
        <button class="btn btn-red" onclick="resetTruck()">ğŸš› æ–°è½¦ (æ¸…ç©ºè®¡æ•°)</button>
    </div>
</div>

<script>
    // é»˜è®¤æ•°æ®
    let data = {
        sources: ["å†œæˆ·å¼ ", "å†œæˆ·æ", "å†œæˆ·ç‹", "æ•£æˆ·æ”¶è´­", "è‡ªå®¶åŸºåœ°"],
        specs: ["6å¤´ç“œ", "7å¤´ç“œ", "8å¤´ç“œ", "èŠ±çš®ç“œ", "æ¬¡æœ", "æ ·å“"],
        trucks: [{
            id: "truck_" + Date.now(),
            customers: [{
                id: "cust_" + Date.now(),
                name: "",
                logs: []
            }],
            session: {
                plate: "", 
                selSource: "", selSpec: "", 
                qty: 70,
                currentCustomerIndex: 0
            }
        }],
        currentTruckIndex: 0
    };

    // åˆå§‹åŒ–
    function init() {
        const local = localStorage.getItem('wh_v4_data');
        if (local) {
            try {
                const parsed = JSON.parse(local);
                // åˆå¹¶æ•°æ®é˜²æ­¢æ—§ç‰ˆå­—æ®µç¼ºå¤±
                if (parsed.trucks) {
                    data = { ...data, ...parsed };
                } else {
                    // å…¼å®¹æ—§ç‰ˆæ•°æ®ç»“æ„
                    data.trucks = [{
                        id: "truck_" + Date.now(),
                        customers: [{
                            id: "cust_" + Date.now(),
                            name: parsed.session?.cust || "",
                            logs: parsed.logs || []
                        }],
                        session: { 
                            plate: parsed.session?.plate || "",
                            selSource: parsed.session?.selSource || "",
                            selSpec: parsed.session?.selSpec || "",
                            qty: parsed.session?.qty || 70,
                            currentCustomerIndex: 0
                        }
                    }];
                }
            } catch(e) { console.error(e); }
        }
        
        // ç¡®ä¿æ•°æ®ç»“æ„æ­£ç¡®
        if (!data.trucks || !Array.isArray(data.trucks)) {
            data.trucks = [{
                id: "truck_" + Date.now(),
                customers: [{
                    id: "cust_" + Date.now(),
                    name: "",
                    logs: []
                }],
                session: {
                    plate: "", 
                    selSource: data.sources[0] || "", 
                    selSpec: data.specs[0] || "", 
                    qty: 70,
                    currentCustomerIndex: 0
                }
            }];
        }
        
        // é»˜è®¤é€‰ä¸­
        data.trucks.forEach(truck => {
            // å…¼å®¹æ—§ç‰ˆæ•°æ®ç»“æ„ - å°†logsè½¬æ¢ä¸ºcustomers
            if (truck.logs && !truck.customers) {
                truck.customers = [{
                    id: "cust_" + Date.now(),
                    name: "",
                    logs: truck.logs
                }];
                delete truck.logs;
            }
            
            if (!truck.customers || !Array.isArray(truck.customers)) {
                truck.customers = [{
                    id: "cust_" + Date.now(),
                    name: "",
                    logs: []
                }];
            }
            
            if (!truck.session) {
                truck.session = {
                    plate: "", 
                    selSource: data.sources[0] || "", 
                    selSpec: data.specs[0] || "", 
                    qty: 70,
                    currentCustomerIndex: 0
                };
            }
            
            if (truck.session.currentCustomerIndex === undefined) {
                truck.session.currentCustomerIndex = 0;
            }
            
            if (!truck.session.selSource && data.sources.length) truck.session.selSource = data.sources[0];
            if (!truck.session.selSpec && data.specs.length) truck.session.selSpec = data.specs[0];
            if (truck.session.qty === undefined) truck.session.qty = 70;
            
            // ç¡®ä¿æ¯ä¸ªå®¢æˆ·éƒ½æœ‰æ­£ç¡®çš„ç»“æ„
            truck.customers.forEach(customer => {
                if (!customer.logs) customer.logs = [];
            });
        });

        renderUI();
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒPWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed'));
            });
        }
    }

    // è·å–å½“å‰è½¦è¾†æ•°æ®
    function getCurrentTruck() {
        return data.trucks[data.currentTruckIndex];
    }
    
    // è·å–å½“å‰å®¢æˆ·æ•°æ®
    function getCurrentCustomer() {
        const truck = getCurrentTruck();
        return truck.customers[truck.session.currentCustomerIndex];
    }

    function renderUI() {
        const currentTruck = getCurrentTruck();
        const currentCustomer = getCurrentCustomer();
        
        // æ¢å¤ç•Œé¢çŠ¶æ€
        document.getElementById('plate').value = currentTruck.session.plate;
        document.getElementById('cust').value = currentCustomer.name;
        document.getElementById('qty-val').innerText = currentTruck.session.qty;
        
        renderGrid('grid-source', data.sources, currentTruck.session.selSource, (val) => {
            currentTruck.session.selSource = val;
            saveState();
            renderUI();
        });
        
        renderGrid('grid-spec', data.specs, currentTruck.session.selSpec, (val) => {
            currentTruck.session.selSpec = val;
            saveState();
            renderUI();
        });

        updateBtnText();
        renderStats();
        renderLogs();
        renderTruckSwitcher();
        renderCustomerSwitcher();
    }
    
    // æ¸²æŸ“å®¢æˆ·åˆ‡æ¢æ 
    function renderCustomerSwitcher() {
        const currentTruck = getCurrentTruck();
        const switcher = document.getElementById('customer-switcher');
        if (!switcher) {
            // åˆ›å»ºå®¢æˆ·åˆ‡æ¢æ 
            const topBar = document.querySelector('.top-bar');
            const customerSwitcherHTML = `
                <div class="customer-switcher" id="customer-switcher">
                    <div class="customer-tab active" data-index="0">å®¢æˆ· 1</div>
                    <div class="customer-tab new" onclick="addNewCustomer()">+ æ·»åŠ å®¢æˆ·</div>
                </div>
            `;
            topBar.insertAdjacentHTML('beforeend', customerSwitcherHTML);
        }
        
        // æ›´æ–°å®¢æˆ·åˆ‡æ¢æ 
        const customerSwitcher = document.getElementById('customer-switcher');
        customerSwitcher.innerHTML = '';
        
        currentTruck.customers.forEach((customer, index) => {
            const name = customer.name || `å®¢æˆ· ${index + 1}`;
            const tab = document.createElement('div');
            tab.className = `customer-tab ${index === currentTruck.session.currentCustomerIndex ? 'active' : ''}`;
            tab.innerText = name;
            tab.dataset.index = index;
            tab.onclick = () => switchCustomer(index);
            customerSwitcher.appendChild(tab);
        });
        
        const addBtn = document.createElement('div');
        addBtn.className = 'customer-tab new';
        addBtn.innerText = '+ æ·»åŠ å®¢æˆ·';
        addBtn.onclick = addNewCustomer;
        customerSwitcher.appendChild(addBtn);
    }

    function renderGrid(id, list, current, callback) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        list.forEach(item => {
            const btn = document.createElement('div');
            btn.className = `select-btn ${item === current ? 'active' : ''}`;
            btn.innerText = item;
            btn.onclick = () => callback(item);
            // å¢å¼ºè§¦æ‘¸ä½“éªŒ
            btn.style.touchAction = 'manipulation';
            btn.style.webkitTapHighlightColor = 'transparent';
            el.appendChild(btn);
        });
    }

    function renderTruckSwitcher() {
        const switcher = document.getElementById('truck-switcher');
        switcher.innerHTML = '';
        
        data.trucks.forEach((truck, index) => {
            const plate = truck.session.plate || `è½¦è¾† ${index + 1}`;
            const tab = document.createElement('div');
            tab.className = `truck-tab ${index === data.currentTruckIndex ? 'active' : ''}`;
            tab.innerText = plate;
            tab.dataset.index = index;
            tab.onclick = () => switchTruck(index);
            switcher.appendChild(tab);
        });
        
        const addBtn = document.createElement('div');
        addBtn.className = 'truck-tab new';
        addBtn.innerText = '+ æ·»åŠ è½¦è¾†';
        addBtn.onclick = addNewTruck;
        switcher.appendChild(addBtn);
    }

    function switchTruck(index) {
        data.currentTruckIndex = index;
        saveState();
        renderUI();
        if(navigator.vibrate) navigator.vibrate(30);
    }

    function addNewTruck() {
        const newTruck = {
            id: "truck_" + Date.now(),
            customers: [{
                id: "cust_" + Date.now(),
                name: "",
                logs: []
            }],
            session: {
                plate: "", 
                selSource: data.sources[0] || "", 
                selSpec: data.specs[0] || "", 
                qty: 70,
                currentCustomerIndex: 0
            }
        };
        data.trucks.push(newTruck);
        data.currentTruckIndex = data.trucks.length - 1;
        saveState();
        renderUI();
        if(navigator.vibrate) navigator.vibrate(50);
    }
    
    // åˆ‡æ¢å®¢æˆ·
    function switchCustomer(index) {
        const currentTruck = getCurrentTruck();
        currentTruck.session.currentCustomerIndex = index;
        saveState();
        renderUI();
        if(navigator.vibrate) navigator.vibrate(30);
    }
    
    // æ›´æ–°å®¢æˆ·åç§°ï¼ˆå®æ—¶ï¼‰
    function updateCustomerName() {
        const currentTruck = getCurrentTruck();
        const currentCustomer = getCurrentCustomer();
        const name = document.getElementById('cust').value.trim();
        currentCustomer.name = name;
        saveState();
        renderCustomerSwitcher();
    }
    
    // æ·»åŠ æ–°å®¢æˆ·
    function addNewCustomer() {
        const currentTruck = getCurrentTruck();
        const newCustomer = {
            id: "cust_" + Date.now(),
            name: "",
            logs: []
        };
        currentTruck.customers.push(newCustomer);
        currentTruck.session.currentCustomerIndex = currentTruck.customers.length - 1;
        saveState();
        renderUI();
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function addQty(delta) {
        const currentTruck = getCurrentTruck();
        let v = parseInt(document.getElementById('qty-val').innerText);
        v += delta;
        if (v < 0) v = 0;
        document.getElementById('qty-val').innerText = v;
        currentTruck.session.qty = v;
        saveState();
        updateBtnText();
        
        // è§¦æ‘¸åé¦ˆ
        if(navigator.vibrate) navigator.vibrate(20);
    }

    function updateBtnText() {
        const currentTruck = getCurrentTruck();
        const sub = document.getElementById('btn-subtext');
        sub.innerText = `${currentTruck.session.qty}ç®± Â· ${currentTruck.session.selSpec} Â· ${currentTruck.session.selSource}`;
    }

    // æ ¸å¿ƒæäº¤
    function commit() {
        const currentTruck = getCurrentTruck();
        const currentCustomer = getCurrentCustomer();
        const cust = document.getElementById('cust').value.trim();
        const plate = document.getElementById('plate').value.trim();
        
        if (!cust || !plate) {
            // å…è®¸ä½†ä¸æ¨èï¼Œç»™ä¸ªè½»å¾®éœ‡åŠ¨
            if(navigator.vibrate) navigator.vibrate([50, 50]);
        }
        
        if (currentTruck.session.qty <= 0) return alert("æ•°é‡å¿…é¡»å¤§äº0");

        const btn = document.querySelector('.main-btn');
        btn.classList.add('loading');

        // æ›´æ–°å½“å‰å®¢æˆ·åç§°
        currentCustomer.name = cust || "æœªçŸ¥å®¢æˆ·";

        const now = new Date();
        const log = {
            id: Date.now(),
            timeStr: now.toLocaleTimeString('zh-CN', {hour12:false}),
            iso: now.toISOString(),
            cust: currentCustomer.name,
            plate: plate || "æœªçŸ¥è½¦ç‰Œ",
            source: currentTruck.session.selSource,
            spec: currentTruck.session.selSpec,
            qty: currentTruck.session.qty,
            palletNumber: currentCustomer.logs.length + 1 // å¢åŠ æ‰˜ç›˜åºå·
        };

        currentCustomer.logs.unshift(log); // æœ€æ–°åœ¨æœ€å‰
        saveState();
        renderUI();
        
        // æˆåŠŸåé¦ˆ
        if(navigator.vibrate) navigator.vibrate(100);
        // æŒ‰é’®é—ªçƒ
        btn.style.background = '#00E676';
        setTimeout(() => {
            btn.style.background = '';
            btn.classList.remove('loading');
        }, 500);
    }

    function renderLogs() {
        const currentCustomer = getCurrentCustomer();
        const el = document.getElementById('history');
        el.innerHTML = '';
        currentCustomer.logs.slice(0, 50).forEach((log, i) => {
            const li = document.createElement('li');
            li.className = `history-item ${i===0 ? 'recent' : ''}`;
            li.innerHTML = `
                <div>
                    <div style="font-size:0.8rem; color:#888">${log.timeStr} - ${log.source}</div>
                    <div style="font-size:1rem; font-weight:bold; color:#fff">${log.spec}</div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <span style="font-size:0.8rem; color:#888; margin-right:10px;">æ‰˜ç›˜ ${log.palletNumber}</span>
                    <span style="font-size:1.2rem; color:${i===0?'#fff':'#ccc'}">x${log.qty}</span>
                    <span onclick="delLog(${log.id})" style="color:#555; font-size:1.5rem; cursor:pointer;">Ã—</span>
                </div>
            `;
            el.appendChild(li);
        });
    }

    function delLog(id) {
        const currentCustomer = getCurrentCustomer();
        if(confirm("åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) {
            currentCustomer.logs = currentCustomer.logs.filter(l => l.id !== id);
            // é‡æ–°è®¡ç®—æ‰˜ç›˜åºå·
            currentCustomer.logs.forEach((log, index) => {
                log.palletNumber = currentCustomer.logs.length - index;
            });
            saveState();
            renderUI();
            if(navigator.vibrate) navigator.vibrate(50);
        }
    }

    function renderStats() {
        const currentCustomer = getCurrentCustomer();
        const currentTruck = getCurrentTruck();
        const bar = document.getElementById('stats-bar');
        // ä¿ç•™Totalï¼Œæ¸…é™¤å…¶ä»–
        const totalPill = bar.firstElementChild;
        bar.innerHTML = '';
        bar.appendChild(totalPill);
        
        // è®¡ç®—æ•´è¾†è½¦çš„æ€»æ•°ï¼ˆæ±‡æ€»æ‰€æœ‰å®¢æˆ·ï¼‰
        let truckTotal = 0;
        currentTruck.customers.forEach(customer => {
            customer.logs.forEach(l => {
                truckTotal += l.qty;
            });
        });
        
        // è®¡ç®—å½“å‰å®¢æˆ·çš„è§„æ ¼ç»Ÿè®¡ï¼ˆç‹¬ç«‹ï¼‰
        let total = 0;
        let map = {};
        
        currentCustomer.logs.forEach(l => {
            total += l.qty;
            if(!map[l.spec]) map[l.spec] = 0;
            map[l.spec] += l.qty;
        });
        
        // æ˜¾ç¤ºæ•´è¾†è½¦çš„æ€»æ•°
        document.getElementById('total-val').innerText = truckTotal;
        
        // æ˜¾ç¤ºå½“å‰å®¢æˆ·çš„è§„æ ¼ç»Ÿè®¡
        Object.keys(map).forEach(spec => {
            const div = document.createElement('div');
            div.className = 'stat-pill';
            div.innerHTML = `${spec} <span class="stat-num">${map[spec]}</span>`;
            bar.appendChild(div);
        });
    }

    function saveState() {
        const currentTruck = getCurrentTruck();
        currentTruck.session.plate = document.getElementById('plate').value;
        localStorage.setItem('wh_v4_data', JSON.stringify(data));
        
        // æ”¯æŒå¤šäººåŒæ—¶ä½¿ç”¨ - ä½¿ç”¨localStorageåŒæ­¥ï¼ˆç®€å•å®ç°ï¼‰
        // å®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨Firebaseç­‰å®æ—¶æ•°æ®åº“
        if ('BroadcastChannel' in window) {
            const channel = new BroadcastChannel('truck_loading_tool');
            channel.postMessage({ type: 'UPDATE', data: data });
        }
    }

    // ç›‘å¬å…¶ä»–çª—å£çš„æ›´æ–°
    if ('BroadcastChannel' in window) {
        const channel = new BroadcastChannel('truck_loading_tool');
        channel.onmessage = (event) => {
            if (event.data.type === 'UPDATE') {
                data = event.data.data;
                renderUI();
            }
        };
    }

    // é…ç½®ä¸å¯¼å‡º
    function openConfig() {
        document.getElementById('cfg-source').value = data.sources.join(',');
        document.getElementById('cfg-spec').value = data.specs.join(',');
        document.getElementById('config-overlay').classList.add('show');
        if(navigator.vibrate) navigator.vibrate(30);
    }
    
    function closeConfig() {
        document.getElementById('config-overlay').classList.remove('show');
        if(navigator.vibrate) navigator.vibrate(30);
    }

    function saveConfig() {
        const s1 = document.getElementById('cfg-source').value.split(/[,ï¼Œ\n]/).map(s=>s.trim()).filter(s=>s);
        const s2 = document.getElementById('cfg-spec').value.split(/[,ï¼Œ\n]/).map(s=>s.trim()).filter(s=>s);
        
        if (s1.length && s2.length) {
            data.sources = s1;
            data.specs = s2;
            // ä¿®æ­£æ‰€æœ‰è½¦è¾†çš„å½“å‰é€‰æ‹©
            data.trucks.forEach(truck => {
                if (!s1.includes(truck.session.selSource)) truck.session.selSource = s1[0];
                if (!s2.includes(truck.session.selSpec)) truck.session.selSpec = s2[0];
            });
            
            saveState();
            renderUI();
            closeConfig();
            if(navigator.vibrate) navigator.vibrate(50);
        } else {
            alert("åˆ—è¡¨ä¸èƒ½ä¸ºç©º");
            if(navigator.vibrate) navigator.vibrate([50, 50, 50]);
        }
    }

    function exportData() {
        const currentTruck = getCurrentTruck();
        let csv = "\uFEFFæ—¶é—´,å®¢æˆ·,è½¦ç‰Œ,å†œæˆ·,è§„æ ¼,æ•°é‡,æ‰˜ç›˜åºå·\n";
        currentTruck.logs.forEach(l => {
            csv += `${l.iso},${l.cust},${l.plate},${l.source},${l.spec},${l.qty},${l.palletNumber}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `è£…è½¦å•_${currentTruck.session.plate||'æœªå‘½å'}_${new Date().toLocaleDateString()}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        if(navigator.vibrate) navigator.vibrate(50);
    }

    function resetTruck() {
        const currentTruck = getCurrentTruck();
        if (confirm("ã€è­¦å‘Šã€‘\nå°†æ¸…ç©ºæ‰€æœ‰è®¡æ•°ï¼Œå¼€å¯æ–°è½¦ä»»åŠ¡ã€‚\nè¯·ç¡®è®¤å·²å¯¼å‡ºæ•°æ®ï¼")) {
            // é‡ç½®è½¦è¾†æ•°æ®
            currentTruck.customers = [{
                id: "cust_" + Date.now(),
                name: "",
                logs: []
            }];
            currentTruck.session.plate = "";
            currentTruck.session.currentCustomerIndex = 0;
            document.getElementById('plate').value = "";
            document.getElementById('cust').value = "";
            saveState();
            renderUI();
            closeConfig();
            if(navigator.vibrate) navigator.vibrate(100);
        }
    }

    // è§¦æ‘¸äº‹ä»¶ä¼˜åŒ–
    document.addEventListener('touchstart', function() {}, { passive: true });

    // åˆå§‹åŒ–åº”ç”¨
    init();
</script>
</body>
</html>